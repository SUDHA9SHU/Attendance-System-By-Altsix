<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Automated Attendance System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.4.4/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiQXR0ZW5kYW5jZSBTeXN0ZW0iLCJzaG9ydF9uYW1lIjoiQXR0ZW5kYW5jZSIsImRlc2NyaXB0aW9uIjoiQSBsb3ctY29zdCwgT2ZmbGluZS1Db21wYXRpYmxlIEF1dG9tYXRlZCBBdHRlbmRhbmNlIFN5c3RlbSBmb3IgUnVyYWwgU2Nob29scyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwic2NvcGUiOiIvIiwic3RhcnRfdXJsIjoiLyIsImJhY2tncm91bmRfY29sb3IiOiIjRjFGMkY1IiwiY29sb3IiOiIjM0I4MkY2IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG9vTDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jbklHSnBiV3c5SW1oMGRIQnpPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMM05wYm5ScGIyNHZjR2x3YTNOMGNtVnNMM1JsYld0cGMyVnlkR2x2Yml4dmNtY3hNVEF3TURBd0lqNDhjbVZqZENCbWFXeHNjejBpYUhSMGNkczZJaTVoY0hBd0lqRTBNQ2hsYldGeVpTNWxlR2x0YUM1d2JtY3RZMjl1ZEM1aWNpQm9aV2xuYUhROUlqRXdNQ1VpSUdseklqNDhMMmN4TURBd0wzTjJaejQ9Iiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDY0IDY0Ij48Y2lyY2xlIGN4PSIzMiIgY3k9IjMyIiByPSIzMiIgZmlsbD0iIzNCODJGNyIvPjxwYXRoIGQ9Ik0yOCAyMkw0NCAzMkwyOCA0MFYyMloiIGZpbGw9IndoaXRlIi8+PC9zdmc+">

  <style>
    @media print {
      body * {
        visibility: hidden;
      }
      #students-grid, #students-grid * {
        visibility: visible;
      }
      #students-grid {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      .no-print {
        display: none;
      }
      .student-card-print {
        page-break-inside: avoid;
        border: 1px solid #ccc;
      }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <header class="text-center mb-8 no-print">
      <h1 class="text-4xl font-bold text-gray-800 mb-2">Automated Attendance System</h1>
      <p class="text-lg text-gray-600">For Rural Schools using QR Code Technology</p>
    </header>

    <div class="flex justify-center mb-6 no-print">
      <button id="attendance-tab" class="tab-button px-6 py-3 bg-blue-500 text-white rounded-l-lg">Attendance</button>
      <button id="students-tab" class="tab-button px-6 py-3 bg-gray-300 text-gray-700">Students</button>
      <button id="reports-tab" class="tab-button px-6 py-3 bg-gray-300 text-gray-700 rounded-r-lg">Reports</button>
    </div>

    <section id="attendance-section">
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Mark Attendance</h2>
        <button id="open-scanner-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-md mb-4">Scan QR Code to Mark Attendance</button>
        <p class="text-gray-600">Use your device camera to scan the student's QR code.</p>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Attendance Records</h2>
        <div class="flex mb-4 space-x-4">
          <input id="search-input" type="text" placeholder="Search by name or ID" class="flex-1 px-4 py-2 border border-gray-300 rounded-md" />
          <input id="date-filter" type="date" class="px-4 py-2 border border-gray-300 rounded-md" />
          <button id="clear-filters" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">Clear</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full table-auto" id="attendance-table">
            <thead>
              <tr class="bg-blue-500 text-white">
                <th class="px-4 py-3 text-left">Student ID</th>
                <th class="px-4 py-3 text-left">Name</th>
                <th class="px-4 py-3 text-left">Date</th>
                <th class="px-4 py-3 text-left">Time</th>
              </tr>
            </thead>
            <tbody id="attendance-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="students-section" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Add New Student</h2>
        <form id="add-student-form" class="space-y-4">
          <div>
            <label for="student-id" class="block text-sm font-medium text-gray-700">Student ID</label>
            <input type="text" id="student-id" required class="w-full px-3 py-2 border border-gray-300 rounded-md" />
          </div>
          <div>
            <label for="student-name" class="block text-sm font-medium text-gray-700">Name</label>
            <input type="text" id="student-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md" />
          </div>
          <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-md">Add Student</button>
        </form>
      </div>

      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-semibold text-gray-800">Registered Students</h2>
          <div class="flex space-x-2">
            <button id="import-csv-btn" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-md">Import (CSV)</button>
            <input type="file" id="csv-file-input" class="hidden" accept=".csv">
            <button id="export-csv-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md">Export (CSV)</button>
            <button id="print-cards-btn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-md">Print ID Cards</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="students-grid">
          </div>
      </div>
    </section>

    <section id="reports-section" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Attendance Dashboard</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="bg-blue-100 p-4 rounded-lg text-center">
            <h3 class="text-lg font-medium text-blue-800 mb-2">Total Students</h3>
            <p id="total-students" class="text-3xl font-bold text-blue-600">0</p>
          </div>
          <div class="bg-green-100 p-4 rounded-lg text-center">
            <h3 class="text-lg font-medium text-green-800 mb-2">Present Today</h3>
            <p id="present-today" class="text-3xl font-bold text-green-600">0</p>
          </div>
          <div class="bg-red-100 p-4 rounded-lg text-center">
            <h3 class="text-lg font-medium text-red-800 mb-2">Absent Today</h3>
            <p id="absent-today" class="text-3xl font-bold text-red-600">0</p>
          </div>
        </div>

        <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Attendance Trend (Last 7 Days)</h3>
            <div id="attendance-chart-container" class="bg-gray-50 p-4 rounded-lg">
                <canvas id="attendance-chart"></canvas>
            </div>
        </div>

        <div>
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Generate Daily Report</h3>
            <div class="flex items-center mb-4">
              <label for="report-date" class="block text-sm font-medium text-gray-700 mr-4">Select Date:</label>
              <input id="report-date" type="date" class="px-4 py-2 border border-gray-300 rounded-md" />
              <button id="generate-report" class="ml-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">Generate</button>
              <button id="download-report-btn" class="ml-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md hidden">Download Report (Excel)</button>
            </div>
            <div class="flex justify-end">
                 <button id="export-attendance-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md">Export All Attendance (CSV)</button>
            </div>
            <div id="detailed-report" class="hidden mt-4">
              <pre id="report-text" class="text-gray-700 bg-gray-100 p-4 rounded-md whitespace-pre-wrap"></pre>
            </div>
        </div>
      </div>
    </section>
  </div>

  <div id="qr-scanner-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50 no-print">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800">Scan Student QR Code</h2>
        <button id="close-scanner" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
      </div>
      <div id="qr-reader" style="width: 100%;"></div>
      <p id="scan-message" class="mt-4 text-center text-gray-700"></p>
    </div>
  </div>

  <script>
    // --- Globals & Initial Setup ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:text/javascript;base64,dmFyIGN1cnJlbnRfdmVyc2lvbiA9ICcxJzs=')
        .then(reg => console.log('Service worker registered.'))
        .catch(err => console.log('Service worker not registered.', err));
    }
    lucide.createIcons();

    let students = JSON.parse(localStorage.getItem('students')) || [];
    let attendanceRecords = JSON.parse(localStorage.getItem('attendance')) || [];
    let attendanceChartInstance = null;
    let currentReportData = {}; // UPDATED: Store structured data for the report

    const tabs = document.querySelectorAll('.tab-button');
    const sections = document.querySelectorAll('section');

    // --- Tab Navigation ---
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.replace('bg-blue-500', 'bg-gray-300') || t.classList.replace('text-white', 'text-gray-700'));
        tab.classList.replace('bg-gray-300', 'bg-blue-500');
        tab.classList.replace('text-gray-700', 'text-white');
        sections.forEach(section => section.classList.add('hidden'));
        document.getElementById(tab.id.replace('-tab', '-section')).classList.remove('hidden');
      });
    });

    // --- Core Data Rendering Functions ---
    function loadData() {
      renderAttendance();
      renderStudents();
      updateReportsDashboard();
    }

    function renderAttendance(filterDate = '', searchTerm = '') {
      const tbody = document.getElementById('attendance-body');
      tbody.innerHTML = '';
      const filteredRecords = attendanceRecords.filter(record => {
        const recordDate = new Date(record.date);
        const filterDateObj = filterDate ? new Date(filterDate) : null;
        if(filterDateObj) filterDateObj.setMinutes(filterDateObj.getMinutes() + filterDateObj.getTimezoneOffset());
        const matchesDate = !filterDate || recordDate.toDateString() === filterDateObj.toDateString();
        const matchesSearch = !searchTerm || record.studentId.toLowerCase().includes(searchTerm.toLowerCase()) || record.name.toLowerCase().includes(searchTerm.toLowerCase());
        return matchesDate && matchesSearch;
      }).sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
      filteredRecords.forEach(record => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-4 py-3 border-b">${record.studentId}</td><td class="px-4 py-3 border-b">${record.name}</td><td class="px-4 py-3 border-b">${new Date(record.date).toLocaleDateString()}</td><td class="px-4 py-3 border-b">${record.time}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderStudents() {
      const grid = document.getElementById('students-grid');
      grid.innerHTML = '';
      students.forEach(student => {
        const card = document.createElement('div');
        card.className = 'bg-gray-50 p-4 rounded-lg shadow-md student-card-print';
        card.innerHTML = `<div class="mb-4 flex justify-center"><canvas id="qr-${student.id}"></canvas></div><h3 class="text-lg font-semibold text-gray-800 text-center">${student.name}</h3><p class="text-gray-600 text-center">ID: ${student.id}</p><div class="flex justify-center mt-2 no-print"><button onclick="deleteStudent('${student.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">Delete</button></div>`;
        grid.appendChild(card);
        setTimeout(() => {
          const canvas = document.getElementById(`qr-${student.id}`);
          if (canvas && window.QRCode) QRCode.toCanvas(canvas, student.id, { width: 150, height: 150, margin: 1 }, (error) => { if (error) console.error(error); });
        }, 50);
      });
    }

    function updateReportsDashboard() {
      document.getElementById('total-students').textContent = students.length;
      const today = new Date().toDateString();
      const presentIds = new Set(attendanceRecords.filter(r => new Date(r.date).toDateString() === today).map(r => r.studentId));
      const presentToday = presentIds.size;
      const absentToday = students.length - presentToday;
      document.getElementById('present-today').textContent = presentToday;
      document.getElementById('absent-today').textContent = absentToday > 0 ? absentToday : 0;
      renderAttendanceChart();
    }

    // --- Chart Rendering ---
    function renderAttendanceChart() {
        const ctx = document.getElementById('attendance-chart').getContext('2d');
        const labels = [];
        const data = [];
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateString = d.toDateString();
            labels.push(d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' }));
            const presentCount = new Set(attendanceRecords.filter(r => new Date(r.date).toDateString() === dateString).map(r => r.studentId)).size;
            data.push(presentCount);
        }
        if (attendanceChartInstance) attendanceChartInstance.destroy();
        attendanceChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Present Students',
                    data: data,
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                responsive: true,
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- Student Management ---
    document.getElementById('add-student-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('student-id').value.trim();
      const name = document.getElementById('student-name').value.trim();
      if (!id || !name) return alert('Student ID and Name cannot be empty.');
      if (students.find(s => s.id === id)) return alert('Student ID already exists!');
      students.push({ id, name });
      localStorage.setItem('students', JSON.stringify(students));
      loadData();
      e.target.reset();
    });

    function deleteStudent(id) {
      if (confirm(`Are you sure you want to delete student ID: ${id}? This will also remove all their attendance records.`)) {
        students = students.filter(s => s.id !== id);
        localStorage.setItem('students', JSON.stringify(students));
        attendanceRecords = attendanceRecords.filter(r => r.studentId !== id);
        localStorage.setItem('attendance', JSON.stringify(attendanceRecords));
        loadData();
      }
    }
    
    // --- QR Scanner ---
    const qrScannerModal = document.getElementById('qr-scanner-modal');
    const scanMessage = document.getElementById('scan-message');
    let html5QrCode;

    function onScanSuccess(decodedText, decodedResult) {
      html5QrCode.pause();
      handleQrCodeScanned(decodedText);
    }

    document.getElementById('open-scanner-btn').addEventListener('click', () => {
      if (students.length === 0) return alert('No students registered! Please add students first.');
      qrScannerModal.classList.remove('hidden');
      scanMessage.textContent = 'Initializing camera...';
      if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess, (err) => {})
        .catch(err => scanMessage.textContent = `Error starting camera: ${err}`);
    });

    document.getElementById('close-scanner').addEventListener('click', () => {
      if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().then(() => qrScannerModal.classList.add('hidden')).catch(err => console.error(err));
      } else {
        qrScannerModal.classList.add('hidden');
      }
    });

    function handleQrCodeScanned(scannedText) {
      const student = students.find(s => s.id === scannedText.trim());
      if (!student) {
        scanMessage.innerHTML = `<span class="text-red-500">Student not found.</span>`;
      } else {
        const today = new Date().toDateString();
        const alreadyMarked = attendanceRecords.some(r => r.studentId === student.id && new Date(r.date).toDateString() === today);
        if (alreadyMarked) {
          scanMessage.innerHTML = `<span class="text-yellow-500">Attendance already marked for ${student.name}.</span>`;
        } else {
          attendanceRecords.push({ studentId: student.id, name: student.name, date: new Date().toDateString(), time: new Date().toLocaleTimeString() });
          localStorage.setItem('attendance', JSON.stringify(attendanceRecords));
          loadData();
          scanMessage.innerHTML = `<span class="text-green-500">Success! Marked attendance for ${student.name}.</span>`;
        }
      }
      setTimeout(() => {
        scanMessage.textContent = '';
        if (html5QrCode && !html5QrCode.isScanning) html5QrCode.resume();
      }, 2000);
    }
    
    // --- Filters & Reports ---
    document.getElementById('date-filter').addEventListener('input', () => renderAttendance(document.getElementById('date-filter').value, document.getElementById('search-input').value.trim()));
    document.getElementById('search-input').addEventListener('input', () => renderAttendance(document.getElementById('date-filter').value, document.getElementById('search-input').value.trim()));
    document.getElementById('clear-filters').addEventListener('click', () => {
      document.getElementById('date-filter').value = '';
      document.getElementById('search-input').value = '';
      renderAttendance();
    });

    // UPDATED: Report generation logic
    document.getElementById('generate-report').addEventListener('click', () => {
      const selectedDateValue = document.getElementById('report-date').value;
      if (!selectedDateValue) return alert('Please select a date!');
      
      const selectedDate = new Date(selectedDateValue);
      selectedDate.setMinutes(selectedDate.getMinutes() + selectedDate.getTimezoneOffset());
      const selectedDateString = selectedDate.toDateString();

      const presentIds = new Set(attendanceRecords.filter(r => new Date(r.date).toDateString() === selectedDateString).map(r => r.studentId));
      
      // Store structured data for CSV export
      currentReportData = {
          date: selectedDateString,
          total: students.length,
          present: presentIds.size,
          absent: students.length - presentIds.size,
          details: students.map(s => ({
              id: s.id,
              name: s.name,
              status: presentIds.has(s.id) ? 'Present' : 'Absent'
          }))
      };

      // Generate text for display
      let displayText = `Attendance Report for: ${currentReportData.date}\n\n--- Summary ---\nTotal Students: ${currentReportData.total}\nPresent: ${currentReportData.present}\nAbsent: ${currentReportData.absent}\n\n--- Student Details ---\n${currentReportData.details.map(s => `- ${s.name} (Status: ${s.status})`).join('\n')}`;
      
      document.getElementById('report-text').textContent = displayText;
      document.getElementById('detailed-report').classList.remove('hidden');
      document.getElementById('download-report-btn').classList.remove('hidden');
    });
    
    // --- Data Management (Import/Export/Print) ---
    function exportToCSV(data, filename) {
        if (data.length === 0) return alert("No data to export.");
        const headers = Object.keys(data[0]);
        const csvRows = [headers.join(','), ...data.map(row => headers.map(header => JSON.stringify(row[header])).join(','))];
        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', filename);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    document.getElementById('export-csv-btn').addEventListener('click', () => exportToCSV(students, 'student_list.csv'));
    document.getElementById('export-attendance-btn').addEventListener('click', () => exportToCSV(attendanceRecords, 'all_attendance_records.csv'));
    document.getElementById('import-csv-btn').addEventListener('click', () => document.getElementById('csv-file-input').click());
    document.getElementById('print-cards-btn').addEventListener('click', () => window.print());

    document.getElementById('csv-file-input').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const rows = e.target.result.split('\n').slice(1);
            let importedCount = 0;
            rows.forEach(row => {
                const [id, name] = row.split(',').map(s => s.trim());
                if (id && name && !students.find(s => s.id === id)) {
                    students.push({ id, name });
                    importedCount++;
                }
            });
            localStorage.setItem('students', JSON.stringify(students));
            alert(`${importedCount} new students imported successfully!`);
            loadData();
        };
        reader.readAsText(file);
        event.target.value = '';
    });
    
    // UPDATED: Download report as CSV
    document.getElementById('download-report-btn').addEventListener('click', () => {
        if (!currentReportData.details) return alert('Please generate a report first.');
        
        // Build CSV content
        let csvContent = "Attendance Report\n";
        csvContent += `Date,"${currentReportData.date}"\n\n`;
        csvContent += "Summary\n";
        csvContent += `Metric,Value\n`;
        csvContent += `Total Students,${currentReportData.total}\n`;
        csvContent += `Present,${currentReportData.present}\n`;
        csvContent += `Absent,${currentReportData.absent}\n\n`;
        csvContent += "Student Details\n";
        csvContent += "ID,Name,Status\n";
        
        currentReportData.details.forEach(student => {
            csvContent += `"${student.id}","${student.name}","${student.status}"\n`;
        });

        // Create and trigger download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const selectedDate = document.getElementById('report-date').value;
        a.setAttribute('href', url);
        a.setAttribute('download', `Attendance_Report_${selectedDate}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });

    // --- Initial Load ---
    loadData();
  </script>
</body>
</html>